---
title: "1.1 Template"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
editor_options: 
  markdown: 
    wrap: 80
---

```{r setup, include=FALSE}
library(learnr)
library(tidyverse)
library(openintro)
library(emo)
library(glue)
library(here)
library(shiny)
shiny_url <- "https://oferengel-posit.shinyapps.io/"
submit_hash_url <- "https://forms.gle/ajEDfePc1jcTukyB7"

gradethis::gradethis_setup(pass.praise = TRUE, fail.encourage = TRUE)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

# Hash generation helpers
# Should ideally be loaded from the imstutorials package when it exists
is_server_context <- function(.envir) {
  # We are in the server context if there are the follow:
  # * input - input reactive values
  # * output - shiny output
  # * session - shiny session
  #
  # Check context by examining the class of each of these.
  # If any is missing then it will be a NULL which will fail.
  
  inherits(.envir$input, "reactivevalues") &
  inherits(.envir$output, "shinyoutput") &
  inherits(.envir$session, "ShinySession")
}

check_server_context <- function(.envir) {
  if (!is_server_context(.envir)) {
    calling_func <- deparse(sys.calls()[[sys.nframe() - 1]])
    err <- paste0("Function `", calling_func, "`", " must be called from an Rmd chunk where `context = \"server\"`")
    stop(err, call. = FALSE)
  }
}


encoder_logic <- function(strip_output = FALSE) {
  p <- parent.frame()
  check_server_context(p)
  # Make this var available within the local context below
  assign("strip_output", strip_output, envir = p)
  # Evaluate in parent frame to get input, output, and session
  local(
    {
      encoded_txt <- shiny::eventReactive(
        input$hash_generate,
        {
          # shiny::getDefaultReactiveDomain()$userData$tutorial_state
          state <- learnr:::get_tutorial_state()
          shiny::validate(shiny::need(length(state) > 0, "No progress yet."))
          shiny::validate(shiny::need(nchar(input$name) > 0, "No name entered."))
          shiny::validate(shiny::need(nchar(input$studentID) > 0, "Please enter your student ID"))
          user_state <- purrr::map_dfr(state, identity, .id = "label")
          user_state <- dplyr::group_by(user_state, label, type, correct)
          user_state <- dplyr::summarize(
            user_state,
            answer = list(answer),
            timestamp = dplyr::first(timestamp),
            .groups = "drop"
          )
          user_state <- dplyr::relocate(user_state, correct, .before = timestamp)
          user_info <- tibble(
            label = c("student_name", "student_id"),
            type = "identifier",
            answer = as.list(c(input$name, input$studentID)),
            timestamp = format(Sys.time(), "%Y-%m-%d %H:%M:%S %Z", tz = "UTC")
          )
          learnrhash::encode_obj(bind_rows(user_info, user_state))
        }
      )
      output$hash_output <- shiny::renderText(encoded_txt())
    },
    envir = p
  )
}

hash_encoder_ui <- {
  shiny::div("If you have completed this tutorial and are happy with all of your", "solutions, please enter your identifying information, then click the button below to generate your hash", shiny::textInput("name", "What's your name?"), shiny::textInput("studentID", "What is your student ID (Gebruikersnaam  s-/p-nummer)?"), shiny::renderText({
    input$caption
  }), )
}


```

## Welcome

Hello, and welcome to **Introduction to data**!


```{r quiz-rows-columns}
quiz(
  caption = "",
  question("how many observations and how many variables are in the `hsb2` dataset? ",
    allow_retry = TRUE, random_answer_order = TRUE,
    answer("200 variables", message = "Nope, try again!"),
    answer("200 observations", correct = TRUE),
    answer("11 variables", correct = TRUE),
    answer("11 observations", message = "Nope, try again!")
  ), 
  question("What do you think: Do cars with bigger engines use more fuel than cars with smaller engines?",
    allow_retry = TRUE, 
    random_answer_order = TRUE, 
    type = "learnr_radio",
    answer("Cars with bigger engines use _more_ fuel.", correct = TRUE, message = "You guessed that there is a positive relationship between engine size and fuel efficiency. Now let's test your hypothesis against data."),
    answer("Cars with bigger engines use _less_ fuel.", correct = TRUE, message = "You guessed that there is a negative relationship between engine size and fuel efficiency. Now let's test your hypothesis with data.")
    )
  )




```

## What's next?

`r emo::ji("one")` [Lesson 1.1: Language of data](https://oferengel-posit.shinyapps.io/01-01-lesson/)

`r emo::ji("two")` [Lesson 1.2: Types of studies](https://oferengel-posit.shinyapps.io/01-02-lesson/)

`r emo::ji("three")` [Lesson 1.3: Case study](https://oferengel-posit.shinyapps.io/01-03-lesson/)

## Hash and submit

```{r encoder, echo=FALSE, context="server"}
encoder_logic()
```

```{r encode, echo=FALSE}
learnrhash::encoder_ui(ui_before = hash_encoder_ui)
```

### Submit your hash in a form

After creating the hash, please copy it, navigate to [this form](`r submit_hash_url`) and fill it in and submit. You will need to submit the form once for every lesson you complete in this tutorial.

```{r img-submit, message=FALSE, warning=FALSE, fig.align='center', out.width="50%"}




p_img <- ifelse(
  file.exists(
    here("tutorials", "images", "Submit-hash.jpg")
    ),
  here("tutorials", "images", "Submit-hash.jpg"),
  here("images", "Submit-hash.jpg")
  )

p_img
if (file.exists(p_img))
  knitr::include_graphics(p_img)
```
